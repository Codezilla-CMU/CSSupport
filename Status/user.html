<!DOCTYPE html>
<html>

<head>
  <base target="_self">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เชคสถานะงาน</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css"
    integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.6/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(to right, #3d3f3f, #252525, #000000);
      margin-top: 30px;
      margin-bottom: 50px;
      font-family: 'Mitr', sans-serif;
      font-size: 15px;
    }

    .card {
      box-shadow: 0 20px 27px 0 rgb(0 0 0 / 5%);
      font-family: 'Mitr', sans-serif;
      font-size: 15px;
    }
   


    h3 {
      text-align: center;
      margin-bottom: 20px;
      color: aliceblue;
    }

    /* เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่าง */
    .card-body {
      padding: 1.5rem;
    }


    /* เพิ่มคลาส "mb-4" เพื่อให้มีระยะห่างด้านล่าง */
    .mb-4 {
      margin-bottom: 1rem !important;
    }
 
 /* CSS */
        .link-like {
            cursor: pointer;
            color: #004C99;
            text-decoration: none;
        }
        
        .link-like.clicked {
            text-decoration: underline;
        }

.cancel_req {
      background-color: #df1130;
      /* สีพื้นหลังของปุ่ม */
      color: #fff;
      /* สีตัวอักษร */
      border: none;
      /* ไม่มีเส้นขอบ */
      
      /* ขนาดของปุ่ม */
      border-radius: 4px;
      /* มุมขอบ */
      cursor: pointer;
      /* สัญลักษณ์เมาส์เป็นเครื่องมือ (cursor) */
      display: flex;
      justify-content: center; 
      align-items: center; 
      
      width: 140px; /* Adjust the width as needed */
      height: 40px; /* Adjust the height as needed */
    }

    /* เมื่อเมาส์ชี้ไปที่ปุ่มสีเขียว */
    .cancel_req:hover {
       background-color: #cd1934;
      /* สีพื้นหลังเมื่อเมาส์ชี้ไปที่ปุ่ม */
    }
    /* CSS */

    
  </style>
</head>

<body>
  <div class="container">
    <!-- Title -->
    <h3>ตรวจสอบสถานะงาน</h3>

    <!-- Main content -->
    <div class="row">
      <!-- Left side -->
      <div class="col-lg-8 mx-auto">
        <!-- Status -->
        <div class="card mb-4">
          <div class="card-body">
            <label class="form-label" for="problem_id_Select">เลือกรหัสปัญหา(Select ProblemID)</label>
            <select class="form-select" id="problem_id_Select"></select>
            <div style="margin-top:1rem">
            <label  class="form-label" for="status">สถานะงาน(Status)</label>
            <input style="color:#009900" type="text" class="form-control"id="status" value="<?= status ?>" readonly placeholder="Status Problem...">
            </div>
          </div>
        </div>
        <!-- Basic information -->
    
        <div  class="card mb-4">
          <div class="card-body">
            <input type="text" id="userId" value="<?= userId ?>" style="display:none">
            <h4 id="showcard" class="h6 mb-4 link-like">ดูเพิ่มเติม(More Status Detail)</h4>

            <!-- เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่างของข้อมูล -->
            <div class="mb-3">
             
            </div>
            <!-- เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่างของข้อมูล -->
          <div id="hiddencard">
            <div  class="mb-3">
              <label class="form-label"for="request">ปัญหาที่เเจ้ง(Problem)</label>
              <input type="text" class="form-control"id="request" value="<?= request ?>" readonly placeholder="Problem...">
            </div>
            <!-- เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่างของข้อมูล -->
            <div class="mb-3">
              <label class="form-label"for="userName">ผู้ซ่อม(Fixer Name)</label>
              <input type="name" class="form-control"id="userName" value="<?= userName ?>" readonly placeholder="Fixer Name...">
            </div>
            <!-- เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่างของข้อมูล -->
            <div class="mb-3">
              <label class="form-label"for="receiveDate">วันที่เเจ้ง(Notified date)</label>
              <input type="text" class="form-control"id="receiveDate" value="<?= receiveDate ?>" readonly placeholder="Date reported problem...">
            </div>
            <div class="mb-3">
              <label class="form-label" for="location">สถานที่เเจ้ง(Notified location)</label>
              <input type="text" class="form-control" id="location" value="<?= location ?>" readonly placeholder="Location problem...">
            </div>
            <div class="mb-3">
              <label id="image" class="form-label" for="problemPicture">รูปภาพ(Image)</label>
              <img id="problemPicture" style="width: 50%; max-height: 50%px;display: block; margin: 0 auto;">
            </div>

            </div>
          </div>

        </div>
       <div  class="card mb-4" id="cancel_card" style="display:none;">
          <div class="card-body" style="align-items:center;">
        <button  class="cancel_req"id="cancel_req" >Cancel request</button>
        <p style="margin-top: 7px;">(Whenever you need to cancel the issue you've reported.)</p>
      </div></div>


      

        <!-- Notification settings -->
        
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <script>

    const cancelButton = document.getElementById("cancel_req");

    cancelButton.addEventListener("click", function () {
        const uid = document.getElementById("userId").value;
        const pid = optionSelect.options[optionSelect.selectedIndex].value;

        // Use SweetAlert for confirmation
        Swal.fire({
            title: "Are you sure?",
            text: "You want to cancel your report? id : "+pid,
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, cancel it!",
        }).then((result) => {
            if (result.isConfirmed) {
            // User clicked the "Yes, cancel it!" button
            google.script.run.removeProblem(pid, uid);
            Swal.fire({
                title: "Cancelled!",
                text: "Your cancellation request has been submitted.",
                icon: "success",
                timer: 850, // Delay in milliseconds (2 seconds in this example)
                showConfirmButton: false, // Hide the "OK" button
            }).then(() => {
                window.top.close();
            });
        }
        });
    });


    function toggleCancelRequestButton(status) {
        const cancelButton = document.getElementById("cancel_card");
        const statusZ = statusValue.value;
        console.log("cancel btn")
        
        if (statusZ === "Received") {
            cancelButton.style.display = "block"; // Display the button
        } else {
            cancelButton.style.display = "none"; // Hide the button
        }
    }  

    var problemList = <?= JSON.stringify(problemList) ?>;
        var pList = JSON.parse(problemList);
        const optionSelect = document.getElementById("problem_id_Select");

        for (let i = 0; i < pList.length; i++) {
            const option = document.createElement("option");
            option.value = pList[i];
            option.textContent = pList[i];
            optionSelect.appendChild(option);
        }

        const requestValue = document.getElementById("request");
        const receiveDateValue = document.getElementById("receiveDate");
        const userNameValue = document.getElementById("userName");
        const locationValue = document.getElementById("location");
        const problemPictureValue = document.getElementById("problemPicture");
        const statusValue = document.getElementById("status");

        // Add an event listener to the statusValue input to update the button visibility when the status changes
        // statusValue.addEventListener("change", toggleCancelRequestButton);

        console.log('pList[0] = ' + pList[0])
        google.script.run.withSuccessHandler(displayProblem).findProblem(pList[0])
        function displayProblem(jsonData) {
            var getproblemData = JSON.stringify(jsonData)
            var parsegetproblemData = JSON.parse(getproblemData)
            var request = parsegetproblemData[0].request
            requestValue.value = request

            var receiveDate = parsegetproblemData[0].receiveDate
            receiveDateValue.value = receiveDate

            var location = parsegetproblemData[0].location
            locationValue.value = location

            var problemPicture = parsegetproblemData[0].problemPicture
            problemPictureValue.src = problemPicture

            var status = parsegetproblemData[0].status
            statusValue.value = status

            var fixerName = parsegetproblemData[0].fixer
            userNameValue.value = fixerName

            var problem_id = parsegetproblemData[0]._id
            toggleCancelRequestButton(status)

            // google.script.run.withSuccessHandler(displayPerson).findPerson(parsegetproblemData[0].owner)
            // function displayPerson(jsonData) {
            //     var getpersonData = JSON.stringify(jsonData)
            //     var parsegetpersonData = JSON.parse(getpersonData)
            //     var name = parsegetpersonData[0].name
            //     userNameValue.value = name
            // }
        }

        optionSelect.addEventListener("change", function () {
            problemPictureValue.src = ""
            const selectedOption = optionSelect.options[optionSelect.selectedIndex];
            const selectedOroblemId = selectedOption.value;
            google.script.run.withSuccessHandler(displayProblem).findProblem(selectedOroblemId)
            function displayProblem(jsonData) {
                var getproblemData = JSON.stringify(jsonData)
                var parsegetproblemData = JSON.parse(getproblemData)
                var request = parsegetproblemData[0].request
                requestValue.value = request

                var receiveDate = parsegetproblemData[0].receiveDate
                receiveDateValue.value = receiveDate

                var location = parsegetproblemData[0].location
                locationValue.value = location

                var problemPicture = parsegetproblemData[0].problemPicture
                problemPictureValue.src = problemPicture

                var status = parsegetproblemData[0].status
                statusValue.value = status

                var fixerName = parsegetproblemData[0].fixer
                userNameValue.value = fixerName

                var problem_id = parsegetproblemData[0]._id
                toggleCancelRequestButton(status)

                // google.script.run.withSuccessHandler(displayPerson).findPerson(parsegetproblemData[0].owner)
                // function displayPerson(jsonData) {
                //     var getpersonData = JSON.stringify(jsonData)
                //     var parsegetpersonData = JSON.parse(getpersonData)
                //     var name = parsegetpersonData[0].name
                //     userNameValue.value = name
                // }
            }
        });

      // สร้างตัวแปรเพื่ออ้างอิงไปยังหัวเรื่อง "รายละเอียดปัญหาที่แจ้ง (Status Detail)"
const detailHeading = document.querySelector('#showcard');

// สร้างตัวแปรเพื่ออ้างอิงไปยังข้อมูลที่ต้องการซ่อนและแสดง
const hiddenCard = document.getElementById('hiddencard');

// ตั้งค่าเริ่มต้นให้ข้อมูลซ่อนอยู่
hiddenCard.style.display = 'none';

// เพิ่มอีเวนต์คลิกบนหัวเรื่อง "รายละเอียดปัญหาที่แจ้ง (Status Detail)"
detailHeading.addEventListener('click', function () {
  // เปลี่ยนสไตล์ของ <h3> เมื่อคลิก
     detailHeading.classList.add('link-like'); // เพิ่มเอฟเฟคเมื่อคลิก
  // ตรวจสอบสถานะการแสดง/ซ่อนข้อมูล
  if (hiddenCard.style.display === 'none') {
    hiddenCard.style.display = 'block'; // แสดงข้อมูลเมื่อคลิก
  } else {
    hiddenCard.style.display = 'none'; // ซ่อนข้อมูลเมื่อคลิกอีกครั้ง
  }
});


 detailHeading.addEventListener('click', function () {
    detailHeading.classList.add('clicked'); // เพิ่มเอฟเฟกเมื่อคลิก
      setTimeout(() => {
                detailHeading.classList.remove('clicked'); // ลบเอฟเฟกเมื่อครบ 1 วินาที
            }, 80); // 0.08 วินาที
        });


     
  </script>
</body>

</html>