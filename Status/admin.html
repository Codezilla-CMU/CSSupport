<!DOCTYPE html>
<html>

<head>

  <base target="_self">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>อัพเดทงานซ่อม</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css"
    integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.6/dist/sweetalert2.min.css">

  <style>
    body {
      background: linear-gradient(to right, #3d3f3f, #252525, #000000);
      margin-top: 30px;
      margin-bottom: 50px;
      font-family: 'Mitr', sans-serif;
      font-size: 15px;
    }

    .card {
      box-shadow: 0 20px 27px 0 rgb(0 0 0 / 5%);
      font-family: 'Mitr', sans-serif;
      font-size: 15px;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: aliceblue;
    }


    /* เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่าง */
    .card-body {
      padding: 1.5rem;
    }



    /* เพิ่มคลาส "mb-4" เพื่อให้มีระยะห่างด้านล่าง */
    .mb-4 {
      margin-bottom: 1rem !important;
    }




    /* เพิ่มระยะห่างด้านบนของปุ่ม "ลบ Dropdown" */
    #drop-electric button.delete {
      margin-top: 10px;
     
    }

    /* เพิ่มระยะห่างด้านบนของ dropdownCount */
    #drop-electric select[name="dropdownCount[]"] {
      margin-top: 10px;
    }

    /* เพิ่มระยะห่างด้านบนของปุ่ม "ลบ Dropdown" */
    #drop-IT button.delete {
      margin-top: 10px;
    }

    /* เพิ่มระยะห่างด้านบนของ dropdownCount */
    #drop-IT select[name="dropdownCount[]"] {
      margin-top: 10px;
    }

    /* เพิ่มระยะห่างด้านบนของปุ่ม "ลบ Dropdown" */
    #drop-plumbing button.delete {
      margin-top: 10px;
    }

    /* เพิ่มระยะห่างด้านบนของ dropdownCount */
    #drop-plumbing select[name="dropdownCount[]"] {
      margin-top: 10px;
    }

    /* เพิ่มระยะห่างด้านบนของปุ่ม "ลบ Dropdown" */
    #drop-other button.delete {
      margin-top: 10px;
    }

    /* เพิ่มระยะห่างด้านบนของ dropdownCount */
    #drop-other select[name="dropdownCount[]"] {
      margin-top: 10px;
    }



    /* ระยะห่างด้านบนของ dropdown */
    .dropdown {
      margin-top: 20px;
      margin-bottom: 10px;
    }

    /* ปรับขนาดของ dropdown select */
    .dropdown select {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* ปรับขนาดของ input อื่น ๆ */
    .dropdown input[type="text"],
    .dropdown input[type="number"] {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 10px;
    }

    /* ปุ่ม "ลบ Dropdown" */
    #blockShow button.delete {
      background-color: #ff4b4b;
      /* สีพื้นหลังของปุ่ม */
      color: #fff;
      /* สีตัวอักษร */
      border: none;
      /* ไม่มีเส้นขอบ */
      padding: 5px 10px;
      /* ขนาดของปุ่ม */
      border-radius: 4px;
      /* มุมขอบ */
      cursor: pointer;
      /* สัญลักษณ์เมาส์เป็นเครื่องมือ (cursor) */
      display: flex;
      justify-content: center; /* แนวนอนตรงกลาง */
      align-items: center; /* แนวตั้งตรงกลาง */
      /* Set the width and height to match the "Update Tool" button */
      width: 160px; /* Adjust the width as needed */
      height: 40px; /* Adjust the height as needed */
    }

    #blockShow button.delete:hover {
      background-color: #e93131;
      /* สีพื้นหลังเมื่อเมาส์ชี้ไปที่ปุ่ม */
    }

    /* ปุ่ม "ลบ Dropdown" */
    .dropdown button.delete {
      background-color: #ff4b4b;
      /* สีพื้นหลังของปุ่ม */
      color: #fff;
      /* สีตัวอักษร */
      border: none;
      /* ไม่มีเส้นขอบ */
      padding: 5px 10px;
      /* ขนาดของปุ่ม */
      border-radius: 4px;
      /* มุมขอบ */
      cursor: pointer;
      /* สัญลักษณ์เมาส์เป็นเครื่องมือ (cursor) */
      display: flex;
      justify-content: center; /* แนวนอนตรงกลาง */
      align-items: center; /* แนวตั้งตรงกลาง */
      /* Set the width and height to match the "Update Tool" button */
      width: 120px; /* Adjust the width as needed */
      height: 40px; /* Adjust the height as needed */
    }

    /* เมื่อเมาส์ชี้ไปที่ปุ่ม "ลบ Dropdown" */
    .dropdown button.delete:hover {
      background-color: #e93131;
      /* สีพื้นหลังเมื่อเมาส์ชี้ไปที่ปุ่ม */
    }

    /* สไตล์ของปุ่มสีเขียว */
    .update-button {
      background-color: #4CAF50;
      /* สีเขียว */
      color: white;
      /* สีของตัวอักษร */
      padding: 10px 20px;
      /* ขนาดของปุ่ม */
      border: none;
      /* ไม่มีเส้นขอบ */
      border-radius: 4px;
      /* มุมขอบ */
      cursor: pointer;
      /* สัญลักษณ์เมาส์เป็นเครื่องมือ (cursor) */
    }

    /* เมื่อเมาส์ชี้ไปที่ปุ่มสีเขียว */
    .update-button:hover {
      background-color: #45a049;
      /* สีพื้นหลังเมื่อเมาส์ชี้ไปที่ปุ่ม */
    }

    /* สไตล์ของปุ่มสีเขียว */
    .updatetool-button {
      background-color: #4CAF50;
      /* สีพื้นหลังของปุ่ม */
      color: #fff;
      /* สีตัวอักษร */
      border: none;
      /* ไม่มีเส้นขอบ */
      padding: 5px 10px;
      /* ขนาดของปุ่ม */
      border-radius: 4px;
      /* มุมขอบ */
      cursor: pointer;
      /* สัญลักษณ์เมาส์เป็นเครื่องมือ (cursor) */
      display: flex;
      justify-content: space-between; /* Pushes the button to the right */
      align-items: center; /* Vertically center-aligns content */
      /* Set the width and height to match the "Update Tool" button */
      width: 120px; /* Adjust the width as needed */
      height: 40px; /* Adjust the height as needed */
    }

    /* เมื่อเมาส์ชี้ไปที่ปุ่มสีเขียว */
    .updatetool-button:hover {
       background-color: #45a049;
      /* สีพื้นหลังเมื่อเมาส์ชี้ไปที่ปุ่ม */
    }
    /* CSS */
        .link-like {
            cursor: pointer;
            color: #004C99;
            text-decoration: none;
        }
        
        .link-like.clicked {
            text-decoration: underline;
        }



  </style>





</head>

<body>
  <div class="container-fluid">

    <div class="container">
      <!-- Title -->
      <div class="d-flex justify-content-between align-items-lg-center py-3 flex-column flex-lg-row">
        <h2> อัพเดทงานที่ท่านซ่อม</h2>

      </div>

      <!-- Main content -->
      <div class="row">
        <!-- Left side -->
        <div class="col-lg-8">
          <!-- Status -->
          <div class="card mb-4">
            <div class="card-body">
              <h3 class="h6">เลือกรหัสปัญหาที่ต้องการอัพเดท</h3>
              <select class="form-select" id="problem_id_Select">

                            </select>
              <h3 class="h6">อัพเดทสถานะงาน</h3>
              <select class="form-select" id="select_status">
                                <option value="draft" selected="">Recieved</option>
                                <option value="active">In Progress</option>
                                <option value="active">Finished</option>
                            </select>
            </div>

          </div>
          <!-- Status -->

          <div class="card mb-4">
            <div class="card-body">
              <input type="text" id="userId" value="<?= userId ?>" style="display:none">
              <h4 id="showcard" class="h6 mb-4 link-like">ดูเพิ่มเติม(More Status Detail)</h4>
              <!-- เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่างของข้อมูล -->

              <!-- เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่างของข้อมูล -->
              <div id="hiddencard">
              <div class="mb-3">
                <label class="form-label" for="request">ปัญหาที่เเจ้ง(Problem)</label>
                <input type="text" class="form-control" id="request" value="<?= request ?>" readonly
                                    placeholder="Problem..."></input>

              </div>
              <!-- เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่างของข้อมูล -->
              <div class="mb-3">
                <label class="form-label" for="userName">ผู้เเจ้ง(User Name)</label>
                <input type="name" class="form-control" id="userName" value="<?= userName ?>" readonly
                                    placeholder="User Name..."></input>

              </div>
              <!-- เพิ่มคลาส "mb-3" เพื่อให้มีระยะห่างด้านล่างของข้อมูล -->
              <div class="mb-3">
                <label class="form-label" for="recieveDate">วันที่เเจ้ง(Notified date)</label>
                <input type="text" class="form-control" id="recieveDate" value="<?= recieveDate ?>" readonly
                                    placeholder="Date reported problem..."></input>

              </div>
              <div class="mb-3">
                <label class="form-label" for="location">สถานที่เเจ้ง(Notified location)</label>
                <input type="text" class="form-control" id="location" value="<?= location ?>" readonly
                                    placeholder="Location problem..."></input>
              </div>

              <h3 class="h6" for="problemPicture">รูปภาพ(Image)</h3>
              <img id="problemPicture" style="width: 50%; height: 50%; display: block; margin: 0 auto;">
              </div>
            </div>
          </div>
        </div>

        <!-- Right side -->
          <div class="col-lg-4">

            <div class="card mb-4">
              <div class="card-body">
                <h3 class="h6">เลือกประเภทเครื่องมือที่ใช้</h3>

                <select id="form-select-type" class="form-select">
                    <option value="select_hidden" hidden selected>เลือก</option>
                    <option value="electric">ไฟฟ้า</option>
                    <option value="IT">ไอที</option>
                    <option value="plumbing">ประปา</option>
                    <option value="other">ทั่วไป</option>
                </select>

                
                <!-- <h3 class="h6" style="margin-top: 10px;">เครื่องมือที่ใช้</h3> -->
                <form id="check_text">
                <div id="dropdown-electric"></div>
                <div id="dropdown-IT"></div>
                <div id="dropdown-plumbing"></div>
                <div id="dropdown-other"></div>
                

                  <input id="updatetool-button" type="submit" class="updatetool-button" style="display:none" value="เพิ่มอุปกรณ์">

                  <!-- <input id="button" type="submit" class="btn btn-primary px-6"> -->
                </form>
              
            
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-body">
                <h3 class="h6" id="show_ul">เครื่องมือที่ใช้</h3>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-body">
                  <!-- สร้างปุ่ม Update -->
                  <button class="update-button" onclick="submitt()">อัพเดทงานซ่อม</button>
              </div>
            </div>
          </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <script>

        var form = document.getElementById("check_text");
        form.addEventListener("submit", function (event) {
            event.preventDefault();
            getDropdownValues();
        });

      
        const selectElement = document.getElementById("form-select-type");

        // เพิ่ม Event Listener เมื่อมีการเลือก option
        selectElement.addEventListener("change", function() {
            // ตรวจสอบค่าที่ถูกเลือก
            const selectedOption = selectElement.value;

            const updateToolButton = document.getElementById("updatetool-button")
            
            // ตรวจสอบว่าถ้าค่าที่ถูกเลือกคือ "ไฟฟ้า"
            if (selectedOption === "electric") {
                // ทำสิ่งที่คุณต้องการเมื่อเลือก "ไฟฟ้า" ที่นี่
                // เช่น แสดงข้อความหรือเรียกฟังก์ชันอื่น ๆ
                addDropdownelectric()

                updateToolButton.style.display = 'block'

                deleteDivIT = document.getElementById("drop-IT")
                if(deleteDivIT)
                 deleteDivIT.remove()
                
                deleteDivplumbing = document.getElementById("drop-plumbing")
                if(deleteDivplumbing)
                 deleteDivplumbing.remove()

                deleteDivother = document.getElementById("drop-other")
                if(deleteDivother)
                 deleteDivother.remove()
            }
            else if (selectedOption === "IT") {
                addDropdownIT()
                
                updateToolButton.style.display = 'block'

                deleteDivelectric = document.getElementById("drop-electric")
                if(deleteDivelectric)
                 deleteDivelectric.remove()
                
                deleteDivplumbing = document.getElementById("drop-plumbing")
                if(deleteDivplumbing)
                 deleteDivplumbing.remove()

                deleteDivother = document.getElementById("drop-other")
                if(deleteDivother)
                 deleteDivother.remove()
            }
            else if (selectedOption === "plumbing") {
                addDropdownplumbing()
                
                updateToolButton.style.display = 'block'

                deleteDivelectric = document.getElementById("drop-electric")
                if(deleteDivelectric)
                 deleteDivelectric.remove()
                
                deleteDivIT = document.getElementById("drop-IT")
                if(deleteDivIT)
                 deleteDivIT.remove()

                deleteDivother = document.getElementById("drop-other")
                if(deleteDivother)
                 deleteDivother.remove()
            }
            else if(selectedOption === "other"){
                addDropdownother()
                
                updateToolButton.style.display = 'block'

                deleteDivelectric = document.getElementById("drop-electric")
                if(deleteDivelectric)
                 deleteDivelectric.remove()
                
                deleteDivIT = document.getElementById("drop-IT")
                if(deleteDivIT)
                 deleteDivIT.remove()

                deleteDivplumbing = document.getElementById("drop-plumbing")
                if(deleteDivplumbing)
                 deleteDivplumbing.remove()
            }
            else{
            }
        });


        var toolList1 = <?= JSON.stringify(tool_list1) ?>;
        var jsonData1 = JSON.parse(toolList1);

        var toolList2 = <?= JSON.stringify(tool_list2) ?>;
        var jsonData2 = JSON.parse(toolList2);

        var toolList3 = <?= JSON.stringify(tool_list3) ?>;
        var jsonData3 = JSON.parse(toolList3);

        var toolList4 = <?= JSON.stringify(tool_list4) ?>;
        var jsonData4 = JSON.parse(toolList4);

        const listOfProblemId = <?= JSON.stringify(problem_id) ?>;
        const parselistOfProblemId = JSON.parse(listOfProblemId);

        // var formshow = document.getElementById("show");
        // if(parselistOfProblemId.length > 0){
        //     formshow.style.display = "inline-block";
        // }
        // else{
        //     formshow.style.display = "none"
        // }

        const optionSelect = document.getElementById("problem_id_Select");

        for (let i = 0; i < parselistOfProblemId.length; i++) {
            const option = document.createElement("option");
            option.value = parselistOfProblemId[i];
            option.textContent = parselistOfProblemId[i];
            optionSelect.appendChild(option);
        }

        const recieveDateValue = document.getElementById("recieveDate");
        const userNameValue = document.getElementById("userName");
        const requestValue = document.getElementById("request");
        const locationValue = document.getElementById("location");
        const problemPictureValue = document.getElementById("problemPicture");

        google.script.run.withSuccessHandler(displayProblem).findProblem(parselistOfProblemId[0])
        function displayProblem(jsonData) {
            var getproblemData = JSON.stringify(jsonData)
            var parsegetproblemData = JSON.parse(getproblemData)
            var request = parsegetproblemData[0].request
            requestValue.value = request

            var recieveDate = parsegetproblemData[0].recieveDate
            recieveDateValue.value = recieveDate

            var location = parsegetproblemData[0].location
            locationValue.value = location

            var problemPicture = parsegetproblemData[0].problemPicture
            problemPictureValue.src = problemPicture

            google.script.run.withSuccessHandler(displayPerson).findPerson(parsegetproblemData[0].owner)
            function displayPerson(jsonData) {
                var getpersonData = JSON.stringify(jsonData)
                var parsegetpersonData = JSON.parse(getpersonData)
                var name = parsegetpersonData[0].name
                userNameValue.value = name
            }
        }

        optionSelect.addEventListener("change", function () {
            problemPictureValue.src = ""
            const selectedOption = optionSelect.options[optionSelect.selectedIndex];
            const selectedOroblemId = selectedOption.value;
            google.script.run.withSuccessHandler(displayProblem).findProblem(selectedOroblemId)
            function displayProblem(jsonData) {
                var getproblemData = JSON.stringify(jsonData)
                var parsegetproblemData = JSON.parse(getproblemData)
                var request = parsegetproblemData[0].request
                requestValue.value = request

                var recieveDate = parsegetproblemData[0].recieveDate
                recieveDateValue.value = recieveDate

                var location = parsegetproblemData[0].location
                locationValue.value = location

                var problemPicture = parsegetproblemData[0].problemPicture
                problemPictureValue.src = problemPicture

                google.script.run.withSuccessHandler(displayPerson).findPerson(parsegetproblemData[0].owner)
                function displayPerson(jsonData) {
                    var getpersonData = JSON.stringify(jsonData)
                    var parsegetpersonData = JSON.parse(getpersonData)
                    var name = parsegetpersonData[0].name
                    userNameValue.value = name
                }
            }
        });

        // สร้างตัวแปรเพื่ออ้างอิงไปยังหัวเรื่อง "รายละเอียดปัญหาที่แจ้ง (Status Detail)"
    const detailHeading = document.querySelector('#showcard');

    // สร้างตัวแปรเพื่ออ้างอิงไปยังข้อมูลที่ต้องการซ่อนและแสดง
    const hiddenCard = document.getElementById('hiddencard');

    // ตั้งค่าเริ่มต้นให้ข้อมูลซ่อนอยู่
    hiddenCard.style.display = 'none';

    // เพิ่มอีเวนต์คลิกบนหัวเรื่อง "รายละเอียดปัญหาที่แจ้ง (Status Detail)"
    detailHeading.addEventListener('click', function () {
      // เปลี่ยนสไตล์ของ <h3> เมื่อคลิก
      detailHeading.classList.add('link-like'); // เพิ่มเอฟเฟคเมื่อคลิก
      // ตรวจสอบสถานะการแสดง/ซ่อนข้อมูล
      if (hiddenCard.style.display === 'none') {
        hiddenCard.style.display = 'block'; // แสดงข้อมูลเมื่อคลิก
      } else {
        hiddenCard.style.display = 'none'; // ซ่อนข้อมูลเมื่อคลิกอีกครั้ง
      }
    });


    detailHeading.addEventListener('click', function () {
      detailHeading.classList.add('clicked'); // เพิ่มเอฟเฟกเมื่อคลิก
      setTimeout(() => {
        detailHeading.classList.remove('clicked'); // ลบเอฟเฟกเมื่อครบ 1 วินาที
      }, 80); // 0.08 วินาที
    });


        function add_device() {
            const dropdownContainer = document.getElementById('dropdown-type');
            const newDropdownContainer = document.createElement('div');
            newDropdownContainer.classList.add('dropdown-container');
            newDropdownContainer.innerHTML = `
                // <button type="button" onclick="addDropdownelectric()">เพิ่มอุปกรณ์</button>
                <select name="dropdowntype[]">
                    <option value="option1">ไฟฟ้า</option>
                    <option value="option2">ไอที</option>
                    <option value="option3">ประปา</option>
                    <option value="option4">ทั่วไป</option>
                </select>
            `;
            dropdownContainer.appendChild(newDropdownContainer);
        }

        function addDropdownelectric() {
            const dropdownContainer = document.getElementById('dropdown-electric');
            const newDropdown = document.createElement("div");
            newDropdown.classList.add("dropdown");
            newDropdown.id = "drop-electric"

            const newDropdownSelect = document.createElement('select');
            newDropdownSelect.name = 'dropdown[]';
            newDropdownSelect.addEventListener('change', function () {
                if (newDropdownSelect.value === "other") {
                    input.style.display = "block";
                    inputprice.style.display = "block";
                    input.required = true
                    inputprice.required = true
                } else {
                    input.style.display = "none";
                    inputprice.style.display = "none";
                }
            });

            const input = document.createElement("input");
            input.setAttribute("type", "text");
            input.classList.add("other-input");
            input.placeholder = "เพิ่มอุปกรณ์...";
            input.style.display = "none";


            const inputprice = document.createElement("input");
            inputprice.setAttribute("type", "number");
            inputprice.classList.add("other-input-price");
            inputprice.id = "ไฟฟ้า"
            inputprice.placeholder = "ราคาต่อชิ้น...";
            inputprice.style.display = "none";
            
            const newDropdownCountSelect = document.createElement('select');
            newDropdownCountSelect.name = 'dropdownCount[]';

            var data = JSON.parse(jsonData1);
            for (var i = 0; i < data.length; i++) {
                var option = document.createElement('option');
                option.value = data[i].price;
                option.textContent = data[i].name;
                newDropdownSelect.appendChild(option);
            }

            var option = document.createElement('option');
            option.value = 'other';
            option.textContent = 'อื่นๆ';
            newDropdownSelect.appendChild(option);

            for (var i = 1; i < 11; i++) {
                var option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                newDropdownCountSelect.appendChild(option);
            }

               // สร้างปุ่ม "ลบ Dropdown"
            var deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'delete';
            deleteButton.textContent = 'ลบเครื่องมือ';
            deleteButton.onclick = function () {
                newDropdown.remove();
                hidden = document.getElementById('form-select-type')
                hidden.value = "select_hidden";
                updateToolButton = document.getElementById('updatetool-button')
                updateToolButton.style.display = 'none'
            };
   
           

            newDropdown.appendChild(newDropdownSelect);
            newDropdown.appendChild(input);
            newDropdown.appendChild(inputprice);
            newDropdown.appendChild(newDropdownCountSelect);
            newDropdown.appendChild(deleteButton)
            dropdownContainer.appendChild(newDropdown);
        }

        function addDropdownIT() {
            const dropdownContainer = document.getElementById('dropdown-IT');
            const newDropdown = document.createElement("div");
            newDropdown.classList.add("dropdown");
            newDropdown.id = "drop-IT"

            const newDropdownSelect = document.createElement('select');
            newDropdownSelect.name = 'dropdown[]';
            newDropdownSelect.addEventListener('change', function () {
                if (newDropdownSelect.value === "other") {
                    input.style.display = "block";
                    inputprice.style.display = "block";
                    input.required = true
                    inputprice.required = true
                } else {
                    input.style.display = "none";
                    inputprice.style.display = "none";
                }
            });

            const input = document.createElement("input");
            input.setAttribute("type", "text");
            input.classList.add("other-input");
            input.placeholder = "เพิ่มอุปกรณ์...";
            input.style.display = "none";

            const inputprice = document.createElement("input");
            inputprice.setAttribute("type", "number");
            inputprice.classList.add("other-input-price");
            inputprice.id = "ไอที"
            inputprice.placeholder = "ราคาต่อชิ้น...";
            inputprice.style.display = "none";

            const newDropdownCountSelect = document.createElement('select');
            newDropdownCountSelect.name = 'dropdownCount[]';

            var data = JSON.parse(jsonData2);
            for (var i = 0; i < data.length; i++) {
                var option = document.createElement('option');
                option.value = data[i].price;
                option.textContent = data[i].name;
                newDropdownSelect.appendChild(option);
            }

            var option = document.createElement('option');
            option.value = 'other';
            option.textContent = 'อื่นๆ';
            newDropdownSelect.appendChild(option);

            for (var i = 1; i < 11; i++) {
                var option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                newDropdownCountSelect.appendChild(option);
            }

            // สร้างปุ่ม "ลบ Dropdown"
            var deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'delete';
            deleteButton.textContent = 'ลบเครื่องมือ';
            deleteButton.onclick = function () {
                newDropdown.remove();
                hidden = document.getElementById('form-select-type')
                hidden.value = "select_hidden";
                updateToolButton = document.getElementById('updatetool-button')
                updateToolButton.style.display = 'none'
            };


            newDropdown.appendChild(newDropdownSelect);
            newDropdown.appendChild(input);
            newDropdown.appendChild(inputprice);
            newDropdown.appendChild(newDropdownCountSelect);
            newDropdown.appendChild(deleteButton)
            dropdownContainer.appendChild(newDropdown);
        }

        function addDropdownplumbing() {
            const dropdownContainer = document.getElementById('dropdown-plumbing');
            const newDropdown = document.createElement("div");
            newDropdown.classList.add("dropdown");
            newDropdown.id = "drop-plumbing"

            const newDropdownSelect = document.createElement('select');
            newDropdownSelect.name = 'dropdown[]';

            newDropdownSelect.addEventListener('change', function () {
                if (newDropdownSelect.value === "other") {
                    input.style.display = "block";
                    inputprice.style.display = "block";
                    input.required = true
                    inputprice.required = true
                } else {
                    input.style.display = "none";
                    inputprice.style.display = "none";
                }
            });

            const input = document.createElement("input");
            input.setAttribute("type", "text");
            input.classList.add("other-input");
            input.placeholder = "เพิ่มอุปกรณ์...";
            input.style.display = "none";

            const inputprice = document.createElement("input");
            inputprice.setAttribute("type", "number");
            inputprice.classList.add("other-input-price");
            inputprice.id = "ประปา"
            inputprice.placeholder = "ราคาต่อชิ้น...";
            inputprice.style.display = "none";

            const newDropdownCountSelect = document.createElement('select');
            newDropdownCountSelect.name = 'dropdownCount[]';

            var data = JSON.parse(jsonData3);
            for (var i = 0; i < data.length; i++) {
                var option = document.createElement('option');
                option.value = data[i].price;
                option.textContent = data[i].name;
                newDropdownSelect.appendChild(option);
            }

            var option = document.createElement('option');
            option.value = 'other';
            option.textContent = 'อื่นๆ';
            newDropdownSelect.appendChild(option);

            for (var i = 1; i < 11; i++) {
                var option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                newDropdownCountSelect.appendChild(option);
            }

            // สร้างปุ่ม "ลบ Dropdown"
            var deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'delete';
            deleteButton.textContent = 'ลบเครื่องมือ';
            deleteButton.onclick = function () {
                newDropdown.remove();
                hidden = document.getElementById('form-select-type')
                hidden.value = "select_hidden";
                updateToolButton = document.getElementById('updatetool-button')
                updateToolButton.style.display = 'none'
            };

            newDropdown.appendChild(newDropdownSelect);
            newDropdown.appendChild(input);
            newDropdown.appendChild(inputprice);
            newDropdown.appendChild(newDropdownCountSelect);
            newDropdown.appendChild(deleteButton)
            dropdownContainer.appendChild(newDropdown);
        }

        function addDropdownother() {
            const dropdownContainer = document.getElementById('dropdown-other');
            const newDropdown = document.createElement("div");
            newDropdown.classList.add("dropdown");
            newDropdown.id = "drop-other"

            const newDropdownSelect = document.createElement('select');
            newDropdownSelect.name = 'dropdown[]';

            newDropdownSelect.addEventListener('change', function () {
                if (newDropdownSelect.value === "other") {
                    input.style.display = "block";
                    inputprice.style.display = "block";
                    input.required = true
                    inputprice.required = true
                    
                } else {
                    input.style.display = "none";
                    inputprice.style.display = "none";
                }
            });

            const input = document.createElement("input");
            input.setAttribute("type", "text");
            input.classList.add("other-input");
            input.placeholder = "เพิ่มอุปกรณ์...";
            input.style.display = "none";
            

            const inputprice = document.createElement("input");
            inputprice.setAttribute("type", "number");
            inputprice.classList.add("other-input-price");
            inputprice.id = "ทั่วไป"
            inputprice.placeholder = "ราคาต่อชิ้น...";
            inputprice.style.display = "none";
            

            const newDropdownCountSelect = document.createElement('select');
            newDropdownCountSelect.name = 'dropdownCount[]';

            var data = JSON.parse(jsonData4);
            for (var i = 0; i < data.length; i++) {
                var option = document.createElement('option');
                option.value = data[i].price;
                option.textContent = data[i].name;
                newDropdownSelect.appendChild(option);
            }

            var option = document.createElement('option');
            option.value = 'other';
            option.textContent = 'อื่นๆ';
            newDropdownSelect.appendChild(option);

            for (var i = 1; i < 11; i++) {
                var option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                newDropdownCountSelect.appendChild(option);
            }

            // สร้างปุ่ม "ลบ Dropdown"
            var deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'delete';
            deleteButton.textContent = 'ลบเครื่องมือ';
            deleteButton.onclick = function () {
                newDropdown.remove();
                hidden = document.getElementById('form-select-type')
                hidden.value = "select_hidden";
                updateToolButton = document.getElementById('updatetool-button')
                updateToolButton.style.display = 'none'
            };

            newDropdown.appendChild(newDropdownSelect);
            newDropdown.appendChild(input);
            newDropdown.appendChild(inputprice);
            newDropdown.appendChild(newDropdownCountSelect);
            newDropdown.appendChild(deleteButton)
            dropdownContainer.appendChild(newDropdown);
        }

        var selectedValues = [];
        var getnewTool = [];
        var submitlist = [];

        function getDropdownValues() {
            var block = document.getElementById('show_ul')
            var blockshow = document.createElement('div')
            blockshow.id = 'blockShow'
            block.appendChild(blockshow)

            const dropdowns = document.querySelectorAll('select[name="dropdown[]"]');
            const dropdownCounts = document.querySelectorAll('select[name="dropdownCount[]"]');

            const getCountOther = [];

            const getNameOther = [];

            dropdowns.forEach(function (dropdown, index) {
                const count = parseInt(dropdownCounts[index].value);

                const optionValue = dropdown.options[dropdown.selectedIndex].value;

                const optionName = dropdown.options[dropdown.selectedIndex].text;

                const selectedOptionInner = selectElement.options[selectElement.selectedIndex];
                const innerOption = selectedOptionInner.innerHTML;


                const doc = {}

                if (optionValue == 'other') {
                    getCountOther.push(count)
                }
                else {
                    doc.name = optionName
                    doc.qty = count
                    doc.price = optionValue
                    doc.type = innerOption;
                    selectedValues.push(doc);
                }
            });

            var textInputElements = document.querySelectorAll(".other-input");
            textInputElements.forEach(function (inputElement) {
                if (inputElement.style.display !== "none") {
                    const text = inputElement.value.trim();
                    getNameOther.push(text)
                }
            });

            var countt = 0;
            var listNewTool = {}
            var textInputElements = document.querySelectorAll(".other-input-price");
            textInputElements.forEach(function (inputElement) {
                const doc = {}
                if (inputElement.style.display !== "none") {
                    const text = inputElement.value.trim();
                    const type = inputElement.id.trim();

                    const selectedOptionInner = selectElement.options[selectElement.selectedIndex];
                    const innerOption = selectedOptionInner.innerHTML;

                    doc.name = getNameOther[countt]
                    doc.qty = getCountOther[countt]
                    doc.price = text
                    doc.type = innerOption

                    selectedValues.push(doc);

                    listNewTool.name = getNameOther[countt]
                    listNewTool.price = text
                    listNewTool.type = type

                    getnewTool.push(listNewTool)

                    countt += 1;
                }
            });

            const outputList = [];
            const nameQtyPriceMap = {};

            for (const item of selectedValues) {
              const name = item.name;
              const qty = item.qty;
              const price = parseInt(item.price);
              const type = item.type;

              if (nameQtyPriceMap[name]) {
                nameQtyPriceMap[name].qty += qty;
                nameQtyPriceMap[name].price += price * qty;
              } else {
                nameQtyPriceMap[name] = { name, qty, price: price * qty ,type};
              }
            }

            for (const name in nameQtyPriceMap) {
              outputList.push(nameQtyPriceMap[name]);
            }

            submitlist = outputList

            //alert('ค่าของ dropdown list: ' + JSON.stringify(outputList));

            var show_ul = document.getElementById('showTool')
            if(show_ul)
              show_ul.remove();

            var show_totalprice = document.getElementById('totalPrice')
            if(show_totalprice)
              show_totalprice.remove();

            var clearbutton = document.getElementById('clear')
            if(clearbutton)
              clearbutton.remove();

            showUl(outputList)

            var backToselect = document.getElementById('form-select-type')
            backToselect.value = 'select_hidden'

            var hidelectric = document.getElementById('drop-electric')
            if(hidelectric){
              hidelectric.remove()
            }

            var hideIT = document.getElementById('drop-IT')
            if(hideIT){
              hideIT.remove()
            }

            var hidepluming = document.getElementById('drop-plumbing')
            if(hidepluming){
              hidepluming.remove()
            }
            
            var hideother = document.getElementById('drop-other')
            if(hideother){
              hideother.remove()
            }

            var updateToolButton = document.getElementById("updatetool-button")
            updateToolButton.style.display = 'none'
        }
        
        var getTotalPrice = 0;
        function showUl(outputList){
            var show_ul = document.getElementById('blockShow')
            // สร้างรายการ ul
            var ul = document.createElement('ul');
            ul.classList.add("showTool");
            ul.id = 'showTool'

            var total_price = 0;
            for (var i = 0; i < outputList.length; i++) {
                const nameAndqty = outputList[i].name + " " + outputList[i].qty + " ราคารวม " + outputList[i].price + " บาท"
                total_price += outputList[i].price
                var li = document.createElement('li');
                li.textContent = nameAndqty
                ul.appendChild(li);
            }

            // เพิ่มรายการ ul ลงในเอกสาร
            var show_totalPrice = document.createElement('h3')
            show_totalPrice.classList.add("h6");
            show_totalPrice.id = 'totalPrice'
            show_totalPrice.innerHTML = 'ราคารวมทั้งหมด : ' + total_price + " บาท"
            getTotalPrice = total_price


            var clearButton = document.createElement('button');
            clearButton.type = 'button';
            clearButton.className = 'delete';
            clearButton.id = 'clear';
            clearButton.textContent = 'เคลียร์เครื่องมือที่ใช้';

            show_ul.appendChild(ul);
            show_ul.appendChild(show_totalPrice)
            show_ul.appendChild(clearButton)

            clearButton.onclick = function () {
                selectedValues = [];
                getnewTool = [];
                submitlist = [];
                getTotalPrice = 0
                show_ul.remove()
            };

        }

        function submitt() {
          //console.log('selectedValues = ' + JSON.stringify(selectedValues))
          var list = JSON.stringify(submitlist)
          var user_id = document.getElementById('userId').value
          const problemId = optionSelect.value;

          var newToollist = JSON.stringify(getnewTool)



          const outputListNewTool = [];
          const nameTypeMap = {};

          for (const item of getnewTool) {
              const name = item.name;
              const price = item.price;
              const type = item.type

              const key = name + type;
              if (nameTypeMap[key]) {
              } else {
                nameTypeMap[key] = { name, price, type };
              }
          }

          for (const key in nameTypeMap) {
            outputListNewTool.push(nameTypeMap[key]);
          }

          console.log('list = ' + list)
      
          const status_select = document.getElementById('select_status')
          const status_update = status_select.options[status_select.selectedIndex].text;
          google.script.run.updateFinish(user_id, problemId,list, status_update, getTotalPrice)
          for (const item of outputListNewTool){
              const name = item.name;
              const price = item.price;
              const type = item.type
              google.script.run.insertNewTool(name, price, type)
          }


          Swal.fire({
              title: '...กรุณารอสักครู...',
              text: '...ระบบกำลังบันทึกข้อมูล...',
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true,
              onBeforeOpen: () => {
                  Swal.showLoading();   }
              ,
              onClose: () => {
                  // เมื่อหน้าต่างข้อความแจ้งเตือนหายไป (หลังจาก 3 วินาที)
                  Swal.fire({
                      title: 'บันทึกข้อมูลเสร็จสิ้น',
                      icon: 'success',
                      showCancelButton: false,
                      confirmButtonText: 'OK'
                  }).then((result) => {
                      if (result.isConfirmed) {
                        window.top.close();
                      }
                  });
              }
          });
        }

  </script>

</body>

</html>