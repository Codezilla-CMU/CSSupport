<!DOCTYPE html>
<html>

<head>
    <base target="_self">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแจ้งซ่อม Online</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.6/dist/sweetalert2.min.css">
    <style>
        input[type=text],
        select,
        textarea {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            background-color: #4CAF50;
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }

        .delete{
            width: 100%;
            background-color: #dd1717;
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }

        .box-gray {
            border-radius: 5px;
            background-color: #f2f2f2;
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="show" style="display:inline-block">
      <div class="box-gray">
          <input type="text" id="userId" value="<?= userId ?>" style="display:none">
          <label for="request">รหัสงาน</label>
          <select id="problem_id_Select">

          </select>

          <label for="request">วันที่เเจ้ง</label>
          <input type="text" id="receiveDate" value="<?= receiveDate ?>" readonly placeholder="วันที่เเจ้ง...">

          <label for="displayName">ผู้แจ้ง</label>
          <input type="text" id="userName" value="<?= userName ?>" readonly placeholder="ผู้แจ้ง...">

          <label for="request">เรื่องที่แจ้ง</label>
          <input type="text" id="request" value="<?= request ?>" readonly placeholder="เรื่องที่แจ้ง...">

          <label for="request">สถานที่</label>
          <input type="text" id="location" value="<?= location ?>" readonly placeholder="สถานที่...">

          <label for="request">รูปประกอบ</label></br></br>
          <img id ="problemPicture" src="<?= problemPicture ?>"width="200" height="350"/>
          
      </div>
      <form id="myForm">
          <div id="dropdownContainer">
              <!-- เริ่มต้นด้วย dropdown list แรก -->
              <!-- <div class="dropdown-container">
                  <button type="button" onclick="Adddevice()">เพิ่มประเภทอุปกรณ์</button>
              </div> -->
              <div id="dropdown-electric">
                  <button type="button" onclick="addDropdownelectric()">เพิ่มอุปกรณ์ไฟฟ้า</button>
                  <select name="dropdowntype[]">
                      <option value="option1">ไฟฟ้า</option>
                  </select><br>
              </div>
              <div id="dropdown-IT">
                  <button type="button" onclick="addDropdownIT()">เพิ่มอุปกรณ์ไอที</button>
                  <select name="dropdowntype[]">
                      <option value="option1">ไอที</option>
                  </select><br>
              </div>
              <div id="dropdown-plumbing">
                  <button type="button" onclick="addDropdownplumbing()">เพิ่มอุปกรณ์ประปา</button>
                  <select name="dropdowntype[]">
                      <option value="option1">ประปา</option>
                  </select><br>
              </div>
              <div id="dropdown-other">
                  <button type="button" onclick="addDropdownother()">เพิ่มอุปกรณ์ทั่วไป</button>
                  <select name="dropdowntype[]">
                      <option value="option1">ทั่วไป</option>
                  </select>
              </div>
          </div>
          <button type="button" value="Submit" onclick="getDropdownValues()">Submit</button>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.3.6/dist/sweetalert2.all.min.js"></script>
    <script>
        var toolList1 = <?= JSON.stringify(tool_list1) ?>;
        var jsonData1 = JSON.parse(toolList1);

        var toolList2 = <?= JSON.stringify(tool_list2) ?>;
        var jsonData2 = JSON.parse(toolList2);

        var toolList3 = <?= JSON.stringify(tool_list3) ?>;
        var jsonData3 = JSON.parse(toolList3);

        var toolList4 = <?= JSON.stringify(tool_list4) ?>;
        var jsonData4 = JSON.parse(toolList4);

        const listOfProblemId = <?= JSON.stringify(problem_id) ?>;
        const parselistOfProblemId = JSON.parse(listOfProblemId);

        var formshow = document.getElementById("show");
        if(parselistOfProblemId.length > 0){
            formshow.style.display = "inline-block";
        }
        else{
            formshow.style.display = "none"
        }

        const optionSelect = document.getElementById("problem_id_Select");

        for (let i = 0; i < parselistOfProblemId.length; i++) {
            const option = document.createElement("option");
            option.value = parselistOfProblemId[i];
            option.textContent = parselistOfProblemId[i];
            optionSelect.appendChild(option);
        }

        const receiveDateValue = document.getElementById("receiveDate");
        const userNameValue = document.getElementById("userName");
        const requestValue = document.getElementById("request");
        const locationValue = document.getElementById("location");
        const problemPictureValue = document.getElementById("problemPicture");

        google.script.run.withSuccessHandler(displayProblem).findProblem(parselistOfProblemId[0])
        function displayProblem(jsonData) {
            var getproblemData = JSON.stringify(jsonData)
            var parsegetproblemData = JSON.parse(getproblemData)
            var request = parsegetproblemData[0].request
            requestValue.value = request

            var receiveDate = parsegetproblemData[0].receiveDate
            receiveDateValue.value = receiveDate

            var location = parsegetproblemData[0].location
            locationValue.value = location

            var problemPicture = parsegetproblemData[0].problemPicture
            problemPictureValue.src = problemPicture

            google.script.run.withSuccessHandler(displayPerson).findPerson(parsegetproblemData[0].owner)
            function displayPerson(jsonData) {
                var getpersonData = JSON.stringify(jsonData)
                var parsegetpersonData = JSON.parse(getpersonData)
                var name = parsegetpersonData[0].name
                userNameValue.value = name
            }
        }

        optionSelect.addEventListener("change", function() {
            problemPictureValue.src = ""
            const selectedOption = optionSelect.options[optionSelect.selectedIndex];
            const selectedOroblemId = selectedOption.value;
            google.script.run.withSuccessHandler(displayProblem).findProblem(selectedOroblemId)
            function displayProblem(jsonData) {
                var getproblemData = JSON.stringify(jsonData)
                var parsegetproblemData = JSON.parse(getproblemData)
                var request = parsegetproblemData[0].request
                console.log(request)
                requestValue.value = request

                var receiveDate = parsegetproblemData[0].receiveDate
                receiveDateValue.value = receiveDate

                var location = parsegetproblemData[0].location
                locationValue.value = location

                var problemPicture = parsegetproblemData[0].problemPicture
                problemPictureValue.src = problemPicture

                google.script.run.withSuccessHandler(displayPerson).findPerson(parsegetproblemData[0].owner)
                function displayPerson(jsonData) {
                    var getpersonData = JSON.stringify(jsonData)
                    var parsegetpersonData = JSON.parse(getpersonData)
                    var name = parsegetpersonData[0].name
                    userNameValue.value = name
                }
            }
        });

        /*function Adddevice() {
            const dropdownContainer = document.getElementById('dropdown-electric');
            const newDropdownContainer = document.createElement('div');
            newDropdownContainer.classList.add('dropdown-container-electric');
            newDropdownContainer.innerHTML = `
                <button type="button" onclick="addDropdownelectric()">เพิ่มอุปกรณ์</button>
                <select name="dropdowntype[]">
                    <option value="option1">ไฟฟ้า</option>
                    <option value="option2">ไอที</option>
                    <option value="option3">ประปา</option>
                    <option value="option4">ทั่วไป</option>
                </select>
            `;
            dropdownContainer.appendChild(newDropdownContainer);
        }*/

        function addDropdownelectric() {
          const dropdownContainer = document.getElementById('dropdown-electric');
          const newDropdownSelect = document.createElement('select');
          newDropdownSelect.name = 'dropdown[]';

          const newDropdownCountSelect = document.createElement('select');
          newDropdownCountSelect.name = 'dropdownCount[]';

          var data = JSON.parse(jsonData1);
          for (var i = 0; i < data.length; i++) {
              var option = document.createElement('option');
              option.value = data[i].name;
              option.textContent = data[i].name;
              newDropdownSelect.appendChild(option);
          }

          for (var i = 1; i < 11; i++) {
              var option = document.createElement('option');
              option.value = i;
              option.textContent = i;
              newDropdownCountSelect.appendChild(option);
          }

          // สร้างปุ่ม "ลบ Dropdown"
          var deleteButton = document.createElement('button');
          deleteButton.type = 'button';
          deleteButton.className = 'delete';
          deleteButton.textContent = 'ลบ Dropdown';
          deleteButton.onclick = function () {
                removeDropdown(this); // เรียกฟังก์ชัน removeDropdown_electric() เมื่อปุ่มถูกคลิก
            };

            dropdownContainer.appendChild(newDropdownSelect);
            dropdownContainer.appendChild(newDropdownCountSelect);
            dropdownContainer.appendChild(deleteButton);
        }

        function addDropdownIT() {
            const dropdownContainer = document.getElementById('dropdown-IT');
            const newDropdownSelect = document.createElement('select');
            newDropdownSelect.name = 'dropdown[]';

            const newDropdownCountSelect = document.createElement('select');
            newDropdownCountSelect.name = 'dropdownCount[]';

            var data = JSON.parse(jsonData2);
            for (var i = 0; i < data.length; i++) {
                var option = document.createElement('option');
                option.value = data[i].name;
                option.textContent = data[i].name;
                newDropdownSelect.appendChild(option);
            }

            for (var i = 1; i < 11; i++) {
              var option = document.createElement('option');
              option.value = i;
              option.textContent = i;
              newDropdownCountSelect.appendChild(option);
            }
            // สร้างปุ่ม "ลบ Dropdown"
            var deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'delete';
            deleteButton.textContent = 'ลบ Dropdown';
            deleteButton.onclick = function () {
                removeDropdown(this); // เรียกฟังก์ชัน removeDropdown_electric() เมื่อปุ่มถูกคลิก
            };

            dropdownContainer.appendChild(newDropdownSelect);
            dropdownContainer.appendChild(newDropdownCountSelect);
            dropdownContainer.appendChild(deleteButton);
        }

        function addDropdownplumbing() {
            const dropdownContainer = document.getElementById('dropdown-plumbing');
            const newDropdownSelect = document.createElement('select');
            newDropdownSelect.name = 'dropdown[]';

            const newDropdownCountSelect = document.createElement('select');
            newDropdownCountSelect.name = 'dropdownCount[]';

            var data = JSON.parse(jsonData3);
            for (var i = 0; i < data.length; i++) {
                var option = document.createElement('option');
                option.value = data[i].name;
                option.textContent = data[i].name;
                newDropdownSelect.appendChild(option);
            }

            for (var i = 1; i < 11; i++) {
              var option = document.createElement('option');
              option.value = i;
              option.textContent = i;
              newDropdownCountSelect.appendChild(option);
            }
            // สร้างปุ่ม "ลบ Dropdown"
            var deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'delete';
            deleteButton.textContent = 'ลบ Dropdown';
            deleteButton.onclick = function () {
                removeDropdown(this); // เรียกฟังก์ชัน removeDropdown_electric() เมื่อปุ่มถูกคลิก
            };

            dropdownContainer.appendChild(newDropdownSelect);
            dropdownContainer.appendChild(newDropdownCountSelect);
            dropdownContainer.appendChild(deleteButton);
        }

        function addDropdownother() {
            const dropdownContainer = document.getElementById('dropdown-other');
            const newDropdownSelect = document.createElement('select');
            newDropdownSelect.name = 'dropdown[]';

            const newDropdownCountSelect = document.createElement('select');
            newDropdownCountSelect.name = 'dropdownCount[]';

            var data = JSON.parse(jsonData4);
            for (var i = 0; i < data.length; i++) {
                var option = document.createElement('option');
                option.value = data[i].name;
                option.textContent = data[i].name;
                newDropdownSelect.appendChild(option);
            }

            for (var i = 1; i < 11; i++) {
              var option = document.createElement('option');
              option.value = i;
              option.textContent = i;
              newDropdownCountSelect.appendChild(option);
            }
            // สร้างปุ่ม "ลบ Dropdown"
            var deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'delete';
            deleteButton.textContent = 'ลบ Dropdown';
            deleteButton.onclick = function () {
                removeDropdown(this); // เรียกฟังก์ชัน removeDropdown_electric() เมื่อปุ่มถูกคลิก
            };

            dropdownContainer.appendChild(newDropdownSelect);
            dropdownContainer.appendChild(newDropdownCountSelect);
            dropdownContainer.appendChild(deleteButton);
        }

        function removeDropdown(button) {
            const dropdownContainer = button.parentNode; // ดึง element ของ dropdown container
            const dropdownSelect = dropdownContainer.querySelector('select[name="dropdown[]"]'); // ดึง element ของ dropdown select ที่มี name เป็น 'dropdown[]'

            const dropdownCountSelect = dropdownContainer.querySelector('select[name="dropdownCount[]"]');

            if (dropdownSelect) {
                dropdownContainer.removeChild(dropdownSelect); // ลบ dropdown select
            }

            if (dropdownCountSelect){
                dropdownContainer.removeChild(dropdownCountSelect); 
            }

            dropdownContainer.removeChild(button); // ลบปุ่ม "ลบ Dropdown"
        }

        function getDropdownValues() {
            const dropdowns = document.querySelectorAll('select[name="dropdown[]"]');
            const dropdownCounts = document.querySelectorAll('select[name="dropdownCount[]"]');

            const selectedValues = [];

            dropdowns.forEach(function (dropdown, index) {
                const count = parseInt(dropdownCounts[index].value);

                const optionValue = dropdown.options[dropdown.selectedIndex].value;

                const doc = {}
                doc.name = optionValue
                doc.qty = count 
                
                selectedValues.push(doc);
            });

            alert('ค่าของ dropdown list: ' + JSON.stringify(selectedValues));
            var list = JSON.stringify(selectedValues)
            var user_id = document.getElementById('userId').value

            const selectedOption = optionSelect.options[optionSelect.selectedIndex];
            const problemId = selectedOption.value;

            google.script.run.updateFinish(user_id, problemId, list)
        }


    </script>
</body>

</html>